<!doctype html>
<html lang="id" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f97316" />
    <meta name="description" content="Sistem Absensi Digital SMK YPPM TOMO - Aplikasi absensi guru yang mudah dan praktis" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Absensi YPPM" />
    <link rel="icon" type="image/png" href="https://iili.io/KjIKMJ9.png" />
    <link rel="shortcut icon" type="image/png" href="https://iili.io/KjIKMJ9.png" />
    <link
      rel="manifest"
      href="data:application/json;base64,eyJuYW1lIjoiQWJzZW5zaSBHdXJ1L1N0YWZmIFNNSyBZUFBNIFRPTU8iLCJzaG9ydF9uYW1lIjoiQWJzZW5zaSBZUFBNIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMxZTQwYWYiLCJkZXNjcmlwdGlvbiI6IlNpc3RlbSBBYnNlbnNpIERpZ2l0YWwgR3VydSBkYW4gU3RhZmYgU01LIFBQUCBUT01PIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vaWlsaS5pby9LaklLTUo5LnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmciLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn0seyJzcmMiOiJodHRwczovL2lpbGkuaW8vS2pJS01KOS5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwicHVycG9zZSI6ImFueSBtYXNrYWJsZSJ9XX0="
    />
    <link rel="apple-touch-icon" href="https://iili.io/KjIKMJ9.png" />
    <title>Absensi Guru SMK YPPM Tomo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet" />
    <style>
      body {
        box-sizing: border-box;
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      * {
        -webkit-tap-highlight-color: transparent;
      }

      .status-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        touch-action: manipulation;
      }

      .status-card:active {
        transform: scale(0.95);
      }

      @media (hover: hover) {
        .status-card:hover {
          transform: translateY(-4px);
          box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }
      }

      .status-card.selected {
        transform: scale(1.02);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.25);
        border: 3px solid rgba(255, 255, 255, 0.9);
        position: relative;
      }

      .status-card.selected::after {
        content: "✓";
        position: absolute;
        top: 8px;
        right: 8px;
        background: white;
        color: #10b981;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .toast {
        position: fixed;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        padding: 14px 24px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        z-index: 1000;
        animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: calc(100vw - 32px);
        text-align: center;
      }

      @keyframes slideDown {
        from {
          transform: translate(-50%, -100px);
          opacity: 0;
        }
        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }

      .toast-success {
        background: #10b981;
        color: white;
      }
      .toast-error {
        background: #ef4444;
        color: white;
      }
      .toast-info {
        background: #f97316;
        color: white;
      }

      .icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      button,
      select,
      input[type="text"] {
        touch-action: manipulation;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      button {
        min-height: 48px;
      }

      select,
      input[type="text"] {
        min-height: 52px;
        font-size: 16px;
      }

      @media (max-width: 640px) {
        .toast {
          font-size: 14px;
          padding: 12px 20px;
        }

        button {
          min-height: 52px;
        }

        select,
        input[type="text"] {
          min-height: 56px;
          font-size: 16px;
        }
      }

      @media (min-width: 768px) {
        button {
          min-height: 54px;
        }

        select,
        input[type="text"] {
          min-height: 58px;
        }
      }

      .install-prompt {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: slideUp 0.5s ease;
        max-width: calc(100vw - 32px);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      @keyframes slideUp {
        from {
          transform: translate(-50%, 100px);
          opacity: 0;
        }
        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }
    </style>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  </head>
  <body class="bg-gradient-to-br from-orange-50 to-orange-100 h-full">
    <!-- Install PWA Prompt -->
    <div id="installPrompt" class="install-prompt" style="display: none">
      <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-xl p-2 flex-shrink-0 shadow-md">
        <img src="https://iili.io/KjIKMJ9.png" alt="Logo" class="w-full h-full object-contain" loading="lazy" />
      </div>
      <div class="flex-1">
        <p class="font-bold text-sm sm:text-base">Absensi Guru/Staff</p>
        <p class="text-xs opacity-90">Install untuk akses lebih cepat</p>
      </div>
      <button id="installButton" class="bg-white text-orange-600 font-bold px-4 py-2.5 rounded-lg text-sm hover:bg-orange-50 transition-all shadow-md">Install</button>
      <button id="dismissInstall" class="text-white opacity-75 hover:opacity-100 ml-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="w-full h-full overflow-auto p-3 sm:p-4 md:p-6">
      <div class="max-w-3xl mx-auto py-4 sm:py-6 md:py-8">
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl p-4 sm:p-6 md:p-8">
          <!-- Header -->
          <div class="text-center mb-6 sm:mb-8">
            <div class="w-20 h-20 sm:w-24 sm:h-24 md:w-28 md:h-28 mx-auto mb-4 bg-gradient-to-br from-orange-500 to-orange-700 rounded-full p-1 shadow-xl">
              <img src="https://iili.io/KjIKMJ9.png" alt="Logo" class="w-full h-full object-contain bg-white rounded-full p-1" loading="lazy" onerror="this.style.display = 'none'" />
            </div>
            <h2 id="schoolName" class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 mb-3 tracking-tight">SMK YPPM TOMO</h2>
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 px-4 sm:px-6 py-2 sm:py-3 rounded-xl inline-block border border-orange-200">
              <p id="currentDate" class="text-sm sm:text-base font-semibold text-orange-800"></p>
            </div>
          </div>
          <h1 id="formTitle" class="text-2xl sm:text-3xl md:text-4xl font-bold text-center mb-6 sm:mb-8 md:mb-10 bg-gradient-to-r from-orange-500 to-orange-700 bg-clip-text text-transparent">
            Form Absensi Guru
          </h1>
          <form id="absensiForm" class="space-y-5 sm:space-y-6">
            <!-- Nama Guru -->
            <div>
              <label for="nama" class="block text-sm sm:text-base font-bold mb-2.5 sm:mb-3 text-gray-800 flex items-center gap-2">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg
                ><span>Nama Guru</span> <span class="text-red-500">*</span>
              </label>
              <select
                id="nama"
                required
                class="w-full px-3 sm:px-4 py-3 sm:py-4 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all text-sm sm:text-base font-medium bg-white hover:border-orange-400"
              >
                <option value="">Pilih nama guru</option>
                <option value="Heri Heryana, S.Pd.">Heri Heryana, S.Pd.</option>
                <option value="SAWALI">SAWALI</option>
                <option value="Hadi Supriadi, S.Kom.">Hadi Supriadi, S.Kom.</option>
                <option value="Bambang Liman Maulana, S.Kom.">Bambang Liman Maulana, S.Kom.</option>
                <option value="Indra Mulyana, S.Pd.">Indra Mulyana, S.Pd.</option>
                <option value="Encep Syafaat Multazam, S.T.">Encep Syafaat Multazam, S.T.</option>
                <option value="Ajeng Saputri, S.S.">Ajeng Saputri, S.S.</option>
                <option value="Suci Indah Novianty, S.Pd.">Suci Indah Novianty, S.Pd.</option>
                <option value="Alih Nurningsih, S.Pd.">Alih Nurningsih, S.Pd.</option>
                <option value="Akus Kustandi, S.S.">Akus Kustandi, S.S.</option>
                <option value="Anna Muliawati, S.Ap.">Anna Muliawati, S.Ap.</option>
                <option value="Azizah Nurzakiyah, S.Kom.">Azizah Nurzakiyah, S.Kom.</option>
                <option value="Sania Listiawati">Sania Listiawati</option>
                <option value="Yofa Andre">Yofa Andre</option>
                <option value="Rifki Al Azhari">Rifki Al Azhari</option>
              </select>
            </div>
            <!-- Tanggal & Jam -->
            <div class="grid grid-cols-2 gap-3 sm:gap-4">
              <div>
                <label for="tanggal" class="block text-sm sm:text-base font-bold mb-2.5 sm:mb-3 text-gray-800 flex items-center gap-2">
                  <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg
                  ><span>Tanggal</span>
                </label>
                <input type="text" id="tanggal" readonly class="w-full px-3 sm:px-4 py-3 sm:py-4 border-2 border-gray-300 rounded-xl text-sm sm:text-base font-medium bg-orange-50" />
              </div>
              <div>
                <label for="jam" class="block text-sm sm:text-base font-bold mb-2.5 sm:mb-3 text-gray-800 flex items-center gap-2">
                  <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg
                  ><span>Waktu</span>
                </label>
                <input type="text" id="jam" readonly class="w-full px-3 sm:px-4 py-3 sm:py-4 border-2 border-gray-300 rounded-xl text-sm sm:text-base font-mono bg-orange-50" />
              </div>
            </div>
            <!-- Status -->
            <div>
              <label class="block text-sm sm:text-base font-bold mb-3 sm:mb-4 text-gray-800 flex items-center gap-2">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                  /></svg
                ><span>Status Kehadiran</span> <span class="text-red-500">*</span>
              </label>
              <input type="hidden" id="status" required />
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                <div
                  class="status-card bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 sm:p-6 text-center shadow-lg min-h-[120px] sm:min-h-[130px] flex flex-col items-center justify-center"
                  onclick="selectStatus('Masuk', this)"
                >
                  <svg class="w-14 h-14 sm:w-16 sm:h-16 mx-auto mb-3 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div class="text-white font-bold text-lg sm:text-xl">Masuk</div>
                </div>
                <div
                  class="status-card bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-5 sm:p-6 text-center shadow-lg min-h-[120px] sm:min-h-[130px] flex flex-col items-center justify-center"
                  onclick="selectStatus('Pulang', this)"
                >
                  <svg class="w-14 h-14 sm:w-16 sm:h-16 mx-auto mb-3 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                    />
                  </svg>
                  <div class="text-white font-bold text-lg sm:text-xl">Pulang</div>
                </div>
                <div
                  class="status-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-5 sm:p-6 text-center shadow-lg min-h-[120px] sm:min-h-[130px] flex flex-col items-center justify-center sm:col-span-1 col-span-1"
                  onclick="selectStatus('Dinas Keluar', this)"
                >
                  <svg class="w-14 h-14 sm:w-16 sm:h-16 mx-auto mb-3 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                  <div class="text-white font-bold text-lg sm:text-xl">Dinas Keluar</div>
                </div>
              </div>
            </div>
            <!-- Kamera -->
            <div>
              <label class="block text-sm sm:text-base font-bold mb-3 text-gray-800">
                <span class="flex items-center gap-2">
                  <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                    />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg
                  ><span>Foto Selfie</span> <span class="text-red-500">*</span>
                </span>
              </label>
              <div id="cameraPreview" class="w-full aspect-video bg-gray-900 rounded-xl sm:rounded-2xl overflow-hidden mb-3" style="display: none">
                <video id="videoElement" autoplay playsinline class="w-full h-full object-cover"></video>
              </div>
              <div id="photoPreview" class="w-full aspect-video bg-gray-100 rounded-xl sm:rounded-2xl overflow-hidden mb-3 border-3 border-dashed border-gray-300" style="display: none">
                <img id="capturedImage" class="w-full h-full object-cover" alt="Foto" />
              </div>
              <canvas id="canvasElement" class="hidden"></canvas>
              <div class="flex gap-2 sm:gap-3">
                <button
                  type="button"
                  id="openCameraBtn"
                  onclick="openCamera()"
                  class="flex-1 py-3 sm:py-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all text-sm sm:text-base"
                >
                  <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                      /></svg
                    ><span>Buka Kamera</span>
                  </span>
                </button>
                <button
                  type="button"
                  id="captureBtn"
                  class="flex-1 py-3 sm:py-4 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold rounded-xl shadow-lg text-sm sm:text-base"
                  style="display: none"
                >
                  <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                      /></svg
                    ><span>Ambil Foto</span>
                  </span>
                </button>
                <button
                  type="button"
                  id="retakeBtn"
                  class="flex-1 py-3 sm:py-4 bg-gradient-to-r from-orange-600 to-orange-700 text-white font-bold rounded-xl shadow-lg text-sm sm:text-base"
                  style="display: none"
                >
                  <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                      /></svg
                    ><span>Foto Ulang</span>
                  </span>
                </button>
              </div>
            </div>
            <!-- Lokasi -->
            <div>
              <label for="lokasi" class="block text-sm sm:text-base font-bold mb-3 text-gray-800 flex items-center gap-2">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg
                ><span>Lokasi GPS</span> <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="lokasi"
                readonly
                class="w-full px-3 sm:px-4 py-3 sm:py-4 border-2 border-gray-300 rounded-xl text-xs sm:text-sm font-mono bg-orange-50"
                placeholder="Mendeteksi GPS..."
              />
              <p id="locationMessage" class="text-xs sm:text-sm mt-2 text-gray-600 font-medium"></p>
            </div>
            <!-- Submit -->
            <button
              type="submit"
              id="submitButton"
              class="w-full py-4 sm:py-5 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl text-base sm:text-lg shadow-xl hover:shadow-2xl transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg
              ><span id="submitButtonText">Kirim Absensi</span>
            </button>
          </form>
        </div>
        <!-- Footer -->
        <footer class="mt-6 sm:mt-8 text-center">
          <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-lg">
            <div class="flex items-center justify-center gap-3 mb-2">
              <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-orange-500 to-orange-700 rounded-full p-0.5 shadow-md">
                <img src="https://iili.io/KjIKMJ9.png" alt="Logo" class="w-full h-full object-contain bg-white rounded-full p-0.5" loading="lazy" onerror="this.style.display = 'none'" />
              </div>
              <div class="text-left">
                <p class="text-sm sm:text-base font-bold text-gray-900">SMK YPPM TOMO</p>
                <p class="text-xs sm:text-sm text-gray-600">Sistem Absensi Digital</p>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-3 mt-3">
              <p class="text-xs sm:text-sm text-gray-500">© 2026 SMK YPPM TOMO. All Rights Reserved.</p>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script>
      let stream = null;
      let locationDetected = false;
      let deferredPrompt;

      // PWA Install Handler
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById("installPrompt").style.display = "flex";
      });

      document.getElementById("installButton").addEventListener("click", async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === "accepted") {
            showToast("✅ Aplikasi berhasil diinstall!", "success");
          }
          deferredPrompt = null;
          document.getElementById("installPrompt").style.display = "none";
        }
      });

      document.getElementById("dismissInstall").addEventListener("click", () => {
        document.getElementById("installPrompt").style.display = "none";
        localStorage.setItem("installDismissed", "true");
      });

      // Check if already dismissed
      if (localStorage.getItem("installDismissed") === "true") {
        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
        });
      }

      // Register Service Worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          const swCode = `
          self.addEventListener('install', (e) => {
            self.skipWaiting();
          });
          
          self.addEventListener('activate', (e) => {
            e.waitUntil(clients.claim());
          });
          
          self.addEventListener('fetch', (e) => {
            e.respondWith(fetch(e.request));
          });
        `;

          const blob = new Blob([swCode], { type: "application/javascript" });
          const swUrl = URL.createObjectURL(blob);

          navigator.serviceWorker
            .register(swUrl)
            .then(() => {
              console.log("Service Worker registered");
            })
            .catch(() => {
              console.log("Service Worker registration failed");
            });
        });
      }

      function showToast(message, type) {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function updateDateTime() {
        const now = new Date();
        const options = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
        document.getElementById("currentDate").textContent = now.toLocaleDateString("id-ID", options);

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = now.getFullYear();
        document.getElementById("tanggal").value = `${day}/${month}/${year}`;

        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const seconds = String(now.getSeconds()).padStart(2, "0");
        document.getElementById("jam").value = `${hours}:${minutes}:${seconds}`;
      }

      function selectStatus(status, element) {
        document.getElementById("status").value = status;
        document.querySelectorAll(".status-card").forEach((card) => card.classList.remove("selected"));
        element.classList.add("selected");
      }

      function detectLocation() {
        const locationInput = document.getElementById("lokasi");
        const locationMessage = document.getElementById("locationMessage");

        if (!navigator.geolocation) {
          locationMessage.textContent = "❌ Browser tidak mendukung GPS";
          return;
        }

        locationMessage.textContent = "⏳ Mendeteksi GPS...";

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude.toFixed(6);
            const lng = position.coords.longitude.toFixed(6);
            locationInput.value = `${lat}, ${lng}`;
            locationMessage.textContent = "✅ Lokasi terdeteksi!";
            locationDetected = true;
            showToast("Lokasi GPS berhasil dideteksi!", "success");
          },
          (error) => {
            locationMessage.textContent = "❌ GPS Error - Aktifkan lokasi!";
            locationInput.value = "GPS Error";
            showToast("Gagal mendeteksi GPS. Aktifkan lokasi!", "error");
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 10000 },
        );
      }

      function openCamera() {
        const constraints = { video: { facingMode: "user" }, audio: false };

        navigator.mediaDevices
          .getUserMedia(constraints)
          .then((mediaStream) => {
            stream = mediaStream;
            document.getElementById("videoElement").srcObject = stream;
            document.getElementById("cameraPreview").style.display = "block";
            document.getElementById("photoPreview").style.display = "none";
            document.getElementById("openCameraBtn").style.display = "none";
            document.getElementById("captureBtn").style.display = "block";
            showToast("Kamera siap!", "info");
          })
          .catch((error) => {
            showToast("Gagal membuka kamera: " + error.message, "error");
          });
      }

      // Add event listeners for camera buttons
      document.getElementById("captureBtn").addEventListener("click", capturePhoto);
      document.getElementById("retakeBtn").addEventListener("click", retakePhoto);

      function capturePhoto() {
        const video = document.getElementById("videoElement");
        const canvas = document.getElementById("canvasElement");
        const image = document.getElementById("capturedImage");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);

        image.src = canvas.toDataURL("image/jpeg", 0.85);

        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }

        document.getElementById("cameraPreview").style.display = "none";
        document.getElementById("photoPreview").style.display = "block";
        document.getElementById("captureBtn").style.display = "none";
        document.getElementById("retakeBtn").style.display = "block";
        showToast("Foto berhasil diambil!", "success");
      }

      function retakePhoto() {
        document.getElementById("photoPreview").style.display = "none";
        document.getElementById("openCameraBtn").style.display = "block";
        document.getElementById("retakeBtn").style.display = "none";
        document.getElementById("capturedImage").src = "";
      }

      // Check if already attended today
      function checkAbsensiToday(nama, status) {
        const today = new Date().toLocaleDateString("id-ID");
        const storageKey = `absensi_${nama}_${status}_${today}`;
        return localStorage.getItem(storageKey) === "true";
      }

      function saveAbsensiToday(nama, status) {
        const today = new Date().toLocaleDateString("id-ID");
        const storageKey = `absensi_${nama}_${status}_${today}`;
        localStorage.setItem(storageKey, "true");
      }

      function showConfirmationModal(data) {
        // Create modal overlay
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4";
        modal.style.animation = "fadeIn 0.3s ease";

        modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform" style="animation: slideUp 0.3s ease;">
          <div class="text-center mb-4">
            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Konfirmasi Data Absensi</h3>
            <p class="text-sm text-gray-600">Pastikan data sudah benar sebelum mengirim</p>
          </div>
          
          <div class="bg-gray-50 rounded-xl p-4 mb-6 space-y-3">
            <div class="flex justify-between items-start">
              <span class="text-sm font-semibold text-gray-600">Nama:</span>
              <span class="text-sm font-bold text-gray-900 text-right">${data.nama}</span>
            </div>
            <div class="flex justify-between items-start">
              <span class="text-sm font-semibold text-gray-600">Status:</span>
              <span class="text-sm font-bold text-gray-900">${data.status}</span>
            </div>
            <div class="flex justify-between items-start">
              <span class="text-sm font-semibold text-gray-600">Tanggal:</span>
              <span class="text-sm font-bold text-gray-900">${data.tanggal}</span>
            </div>
            <div class="flex justify-between items-start">
              <span class="text-sm font-semibold text-gray-600">Jam:</span>
              <span class="text-sm font-bold text-gray-900">${data.jam}</span>
            </div>
            <div class="flex justify-between items-start">
              <span class="text-sm font-semibold text-gray-600">Lokasi:</span>
              <span class="text-sm font-mono text-xs text-gray-900 text-right">${data.lokasi}</span>
            </div>
            <div class="flex justify-between items-start">
              <span class="text-sm font-semibold text-gray-600">Foto:</span>
              <span class="text-sm font-bold text-green-600">✓ Sudah diambil</span>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button id="cancelBtn" class="flex-1 py-3 bg-gray-200 text-gray-800 font-bold rounded-xl hover:bg-gray-300 transition-all">
              Batal
            </button>
            <button id="confirmBtn" class="flex-1 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-xl hover:shadow-lg transition-all">
              Ya, Kirim
            </button>
          </div>
        </div>
      `;

        document.body.appendChild(modal);

        return new Promise((resolve) => {
          modal.querySelector("#confirmBtn").addEventListener("click", () => {
            modal.remove();
            resolve(true);
          });

          modal.querySelector("#cancelBtn").addEventListener("click", () => {
            modal.remove();
            resolve(false);
          });

          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
              resolve(false);
            }
          });
        });
      }

      document.getElementById("absensiForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const nama = document.getElementById("nama").value;
        const tanggal = document.getElementById("tanggal").value;
        const jam = document.getElementById("jam").value;
        const status = document.getElementById("status").value;
        const lokasi = document.getElementById("lokasi").value;
        const foto = document.getElementById("capturedImage").src;

        if (!nama) {
          showToast("Pilih nama guru!", "error");
          return;
        }
        if (!status) {
          showToast("Pilih status absensi!", "error");
          return;
        }
        if (!foto) {
          showToast("Ambil foto selfie!", "error");
          return;
        }
        if (!locationDetected) {
          showToast("Tunggu GPS terdeteksi!", "error");
          return;
        }

        // Check duplicate attendance
        if (checkAbsensiToday(nama, status)) {
          const duplicateModal = document.createElement("div");
          duplicateModal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4";
          duplicateModal.innerHTML = `
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Absensi Sudah Tercatat!</h3>
            <p class="text-gray-600 mb-6">Anda sudah melakukan absensi <strong>${status}</strong> hari ini.</p>
            <button onclick="this.parentElement.parentElement.remove()" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-all">
              OK, Mengerti
            </button>
          </div>
        `;
          document.body.appendChild(duplicateModal);
          return;
        }

        const data = {
          jenis: "absensi",
          nama: nama,
          tanggal: tanggal,
          jam: jam,
          status: status,
          lokasi: lokasi,
          foto: foto,
        };

        // Show confirmation modal
        const confirmed = await showConfirmationModal(data);

        if (!confirmed) {
          showToast("Absensi dibatalkan", "info");
          return;
        }

        const submitButton = document.getElementById("submitButton");
        submitButton.disabled = true;
        submitButton.style.opacity = "0.6";
        document.getElementById("submitButtonText").textContent = "⏳ Mengirim...";

        const url = "https://script.google.com/macros/s/AKfycbyJozbt1i_hGH-0c61fX-IEKgTnJdsm8-E4eqoRrJZGNuVsJMNswJDWubigwef_tK8_/exec";

        fetch(url, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then(() => {
            saveAbsensiToday(nama, status);
            showToast("✅ Absensi berhasil dikirim!", "success");

            // Reset form
            document.getElementById("nama").value = "";
            document.getElementById("status").value = "";
            document.getElementById("capturedImage").src = "";
            document.getElementById("photoPreview").style.display = "none";
            document.getElementById("openCameraBtn").style.display = "block";
            document.getElementById("retakeBtn").style.display = "none";
            document.querySelectorAll(".status-card").forEach((card) => card.classList.remove("selected"));

            submitButton.disabled = false;
            submitButton.style.opacity = "1";
            document.getElementById("submitButtonText").textContent = "Kirim Absensi";

            // Re-detect location for next submission
            locationDetected = false;
            setTimeout(detectLocation, 500);
          })
          .catch((error) => {
            showToast("❌ Error: " + error.message, "error");
            submitButton.disabled = false;
            submitButton.style.opacity = "1";
            document.getElementById("submitButtonText").textContent = "Kirim Absensi";
          });
      });

      // Initialize
      updateDateTime();
      setInterval(updateDateTime, 1000);
      setTimeout(detectLocation, 500);
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9c0414fe2118409a',t:'MTc2ODgwMjExNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener) document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState && ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
